---
title: "analysis"
author: "Elen Ghalechyan, Section A"
date: "2024-11-29"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(dplyr)
library(sf)
library(ggplot2)
library(corrplot)
library(lubridate)
library(systemfonts)
library(GGally)
library(knitr)
library(ggcorrplot)
library(FactoMineR)
library(factoextra)
library(pheatmap)

```

```{r}
data_cleaned <- read.csv("cleaned_water_data.csv")
coordinates <- read.csv("coordinates.csv")
```


```{r}
station_counts <- data_cleaned %>%
  group_by(Water_Object) %>%
  summarise(Number_of_Stations = n())%>%
  arrange(desc(Number_of_Stations))
```
```{r}
top_bottom_counts <- bind_rows(
  head(station_counts, 5), 
  tail(station_counts, 5)  
)

top_bottom_counts
```

```{r}
ggplot(station_counts, aes(x = reorder(Water_Object, -Number_of_Stations), y = Number_of_Stations)) +
  geom_bar(stat = "identity", fill = "steelblue", color = "black", width = 0.7) +
  labs(
    title = "Number of Sampling Stations per Water Object",
    subtitle = "Visualizing the distribution of stations across various water objects",
    x = "Water Object",
    y = "Number of Stations"
  ) +
  theme_classic(base_family = "Arial Unicode MS") +
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5, family = "Arial Unicode MS"), 
    plot.subtitle = element_text(size = 12, hjust = 0.5, family = "Arial Unicode MS"),
    axis.text.x = element_text(angle = 90, hjust = 1, family = "Arial Unicode MS"),
  )

```
```{r}
arm_sf <- st_read('Armenia_Marzes/Armenia_Marzes.shp', quiet = TRUE) 
```

```{r}
arm_df <- arm_sf %>% group_by(MarzID) %>%
  st_cast("POINT")
arm_df = data.frame(Marz = arm_df$Name_Eng, st_coordinates(arm_df))
```


```{r}
ggplot(arm_df, aes(x = X, y = Y, group = Marz)) +
  geom_polygon(fill = 'white', color = 'black') + coord_fixed()+ theme_void()
```
```{r}
coordinates_data_cleaned <- coordinates %>%
  filter(!is.na(as.numeric(Latitude)) & !is.na(as.numeric(Longitude))) %>%
  mutate(
    Latitude = as.numeric(Latitude),
    Longitude = as.numeric(Longitude)
  )
```



```{r}
# region_counts <- coordinates_data_cleaned %>%
#   group_by(Region) %>%
#   summarise(Number_of_Stations = n())
# 
# arm_sf <- arm_sf %>%
#   left_join(region_counts, by = c("Name_Eng" = "Region"))
# 
# 
# ggplot(data = arm_sf) +
#   geom_sf(aes(fill = Number_of_Stations), color = "black") +
#   scale_fill_gradient(low = "lightblue", high = "darkblue", na.value = "grey") +
#   labs(
#     title = "Regional Distribution of Water Monitoring Stations",
#     fill = "Number of Stations",
#     x = "",
#     y = ""
#   ) +
#   theme_void() +
#   theme(
#     plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
#     legend.position = "right"
#   )
```







Hypothesis 1: There is a spatial correlation between water quality indicators (e.g., BOD5, COD) and the geographic location (X, Y coordinates) of the sampling stations.







**Exploratory Data Analysis (EDA)**

```{r}
# Univariate Analysis - Histogram of Dissolved Oxygen
ggplot(data_cleaned, aes(x = Dissolved_Oxygen)) +
  geom_histogram(binwidth = 1, fill = "blue", color = "black") +
  labs(title = "Distribution of Dissolved Oxygen", x = "Dissolved Oxygen (mg/L)", y = "Frequency")
```
```{r}
# Temporal Trends - Dissolved Oxygen Over Time
ggplot(data_cleaned, aes(x = DateTime, y = Dissolved_Oxygen)) +
  geom_line(color = "blue") +
  labs(title = "Dissolved Oxygen Over Time", x = "Date", y = "Dissolved Oxygen (mg/L)")
```


**Outlier Detection**

**Time Series Analysis**

```{r}
# Time Series for BOD5 and COD
ggplot(data_cleaned, aes(x = DateTime)) +
  geom_line(aes(y = BOD5, color = "BOD5")) +
  geom_line(aes(y = COD, color = "COD")) +
  labs(title = "Temporal Trends of BOD5 and COD", x = "Datetime", y = "Concentration (mg/L)") +
  scale_color_manual(values = c("BOD5" = "green", "COD" = "orange"))
```

**Correlation Analysis**

```{r}
# Select numeric columns
numeric_cols <- data_cleaned %>%
  select(where(is.numeric))

# Compute correlation matrix
cor_matrix <- cor(numeric_cols, use = "complete.obs")
pairs(numeric_cols[, 1:8], main = "Scatterplot Matrix for Selected Variables")
```

**Principal Component Analysis (PCA)**

```{r}
numeric_data <- data_cleaned %>%
  select(where(is.numeric))
```

```{r}
numeric_data <- numeric_data %>%
  select(where(~ all(!is.na(.)))) 
```

```{r}
numeric_data_scaled <- scale(numeric_data)
```

```{r}
data_pca = prcomp(x = numeric_data_scaled, center = T, scale. = T)
summary(data_pca)
```

```{r}
pheatmap(numeric_data_scaled, cluster_rows = T, cluster_cols = T)
```

```{r}
fviz_screeplot(data_pca, addlabels = T)
```

```{r}
fviz_pca_biplot(data_pca, axes = c(1, 2), geom = c("point", "text"), label = "var")
```


```{r}
fviz_pca_var(data_pca, col.var = "black") 
```

**Clustering**

```{r}
# Use scaled numeric data from the PCA section for clustering
data_for_clustering <- numeric_data_scaled

# Step 2: K-means Clustering
set.seed(123)  # For reproducibility
fviz_nbclust(data_for_clustering, FUNcluster = factoextra::hcut,
method = "wss")

```

```{r}
fviz_nbclust(data_for_clustering, kmeans, method = "wss") +
labs(title = "K-means Scree Plot")

```
```{r}
# Apply K-means clustering
set.seed(123)
optimal_k <- 3  # Based on the elbow plot
kmeans_result <- kmeans(data_for_clustering, centers = optimal_k, nstart = 25)

# Add cluster labels to the original data
data_cleaned$Cluster <- as.factor(kmeans_result$cluster)

# Create a scatter plot using two selected columns
ggplot(data_cleaned, aes(x = Dissolved_Oxygen, y = BOD5, color = Cluster)) +
  geom_point(size = 3, alpha = 0.7) +
  theme_minimal() +
  labs(
    title = "K-means Clustering Visualization",
    x = "Dissolved Oxygen (mg/L)",
    y = "BOD5 (mg/L)",
    color = "Cluster"
  ) +
  scale_color_brewer(palette = "Set2")

```


```{r}
# Step 3: Hierarchical Clustering
# Compute dissimilarity matrix
dist_matrix <- dist(data_for_clustering, method = "euclidean")

# Perform hierarchical clustering
hclust_result <- hclust(dist_matrix, method = "ward.D2")

# Plot the dendrogram
plot(hclust_result, labels = FALSE, hang = -1,
     main = "Dendrogram of Hierarchical Clustering",
     xlab = "Samples",
     ylab = "Height")

# Cut the dendrogram into clusters
hclust_clusters <- cutree(hclust_result, k = 3)

# Add hierarchical clustering labels to the original data
data_cleaned$HCluster <- as.factor(hclust_clusters)

```



**Geospatial Analysis**


```{r}
# Filter data for "Sevan Lake" and "Debed river basin"
filtered_data <- data_cleaned %>%
  filter(River_Basin %in% c("Sevan Lake", "Debed river basin", "Metsamor river basin"))

# Create a visually appealing boxplot
ggplot(filtered_data, aes(x = River_Basin, y = Dissolved_Oxygen, fill = River_Basin)) +
  geom_boxplot(outlier.color = "red", outlier.size = 2) + # Highlight outliers
  labs(
    title = "Dissolved Oxygen by River Basin",
    subtitle = "Comparing Sevan Lake and Debed River Basin",
    x = "River Basin",
    y = "Dissolved Oxygen (mg/L)"
  ) +
  scale_fill_manual(values = c("Sevan Lake" = "#1f77b4", "Debed river basin" = "#ff7f0e", "Metsamor river basin"='green')) + # Custom colors
  theme(
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5),
    plot.subtitle = element_text(size = 12, hjust = 0.5),
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 14),
    legend.position = "none" # Hide legend as it's clear from labels
  )


```


